<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Highlight Configuration Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        nav {
            background: #2d3748;
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        nav ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        nav a {
            color: #e2e8f0;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s;
        }

        nav a:hover {
            color: #667eea;
        }

        main {
            padding: 2rem;
        }

        section {
            margin-bottom: 3rem;
        }

        h2 {
            color: #2d3748;
            font-size: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #667eea;
        }

        h3 {
            color: #4a5568;
            font-size: 1.5rem;
            margin: 1.5rem 0 1rem;
        }

        h4 {
            color: #718096;
            font-size: 1.2rem;
            margin: 1rem 0 0.5rem;
        }

        p {
            margin-bottom: 1rem;
        }

        ul, ol {
            margin-left: 2rem;
            margin-bottom: 1rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        code {
            background: #f7fafc;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #e53e3e;
        }

        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            border-left: 4px solid #667eea;
        }

        pre code {
            background: transparent;
            color: inherit;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f7fafc;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }

        .badge.required {
            background: #e53e3e;
        }

        .badge.optional {
            background: #48bb78;
        }

        .note {
            background: #ebf8ff;
            border-left: 4px solid #4299e1;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .warning {
            background: #fffaf0;
            border-left: 4px solid #ed8936;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .success {
            background: #f0fff4;
            border-left: 4px solid #48bb78;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .color-swatch {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            vertical-align: middle;
            margin-right: 0.5rem;
            border: 1px solid #cbd5e0;
        }

        footer {
            background: #2d3748;
            color: #e2e8f0;
            text-align: center;
            padding: 2rem;
            margin-top: 3rem;
        }

        @media (max-width: 768px) {
            nav ul {
                flex-direction: column;
                gap: 0.5rem;
            }

            header h1 {
                font-size: 1.8rem;
            }

            main {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ“˜ Highlight Configuration Documentation</h1>
            <p>MUI/Kendo DataGrid Conditional Formatting System</p>
        </header>

        <nav>
            <ul>
                <li><a href="#overview">Overview</a></li>
                <li><a href="#flow">Flow</a></li>
                <li><a href="#data-shapes">Data Shapes</a></li>
                <li><a href="#modes">Modes</a></li>
                <li><a href="#rules">Rules</a></li>
                <li><a href="#validation">Validation</a></li>
                <li><a href="#troubleshooting">Troubleshooting</a></li>
            </ul>
        </nav>

        <main>
            <section id="overview">
                <h2>1. Overview</h2>
                <p>The <strong>Highlight system</strong> applies conditional formatting (background + text colors) to table cells in grids (MUI DataGrid Premium / Kendo-like rendering).</p>
                <p>Highlights are configured <strong>per column</strong> using a <code>highlight</code> object. During rendering, each cell uses this config to decide its styling.</p>
                
                <h3>You can use highlights to:</h3>
                <ul>
                    <li>Mark values as <strong>good/bad</strong></li>
                    <li>Apply <strong>bucketed ranges</strong></li>
                    <li>Color <strong>categories</strong></li>
                    <li>Show <strong>gradients</strong></li>
                    <li>Apply <strong>static styling</strong></li>
                    <li>Apply <strong>KNN/nearest-match coloring</strong></li>
                    <li>Apply <strong>row-aware rule overrides</strong> (dynamic behavior per row)</li>
                </ul>
            </section>

            <section id="flow">
                <h2>2. Where It Runs (High-Level Flow)</h2>
                
                <h3>2.1 Column Initialization (once per load)</h3>
                <p>When API columns arrive:</p>
                <ol>
                    <li><code>normalizeConfig(column.highlight)</code> - lowercases mode, trims condition</li>
                    <li><code>safeValidateConfig(normalized)</code> - invalid configs are skipped (so UI never crashes)</li>
                    <li>If valid â†’ store <code>columnDef.highlight = normalized</code></li>
                </ol>

                <h3>2.2 Cell Rendering (runs per cell)</h3>
                <p>When a cell is rendered:</p>
                <ol>
                    <li>Read the cell value</li>
                    <li>If highlight exists:
                        <ul>
                            <li><code>effectiveCfg = resolveRule(highlight, row)</code> <em>(optional row-based override)</em></li>
                            <li><code>{ bg, text } = pickStyle(value, effectiveCfg, rowData, fallbackText)</code></li>
                        </ul>
                    </li>
                    <li>Apply styling to <code>&lt;span&gt;</code> or <code>&lt;a&gt;</code> (if link exists)</li>
                </ol>
            </section>

            <section id="data-shapes">
                <h2>3. Important Data Shapes (Why Rules + Target Work)</h2>
                <p>You usually have <strong>two row shapes</strong>:</p>

                <h3>A) Raw API row (<code>rowData</code>, <code>rawRows</code>)</h3>
                <p>Cells may be objects with link + value:</p>
                <pre><code>{
  "rate_calculation": { 
    "value": "10.49", 
    "link": { "base_url": "...", "filters": {...} } 
  },
  "Quality Measure": "Pneumonia 30-Day Readmission Rate",
  "id": 6
}</code></pre>

                <h3>B) Processed row (<code>params.row</code>, <code>rowsData</code>)</h3>
                <p>You flatten values for DataGrid:</p>
                <pre><code>{
  "rate_calculation": 10.49,
  "Quality Measure": "Pneumonia 30-Day Readmission Rate",
  "id": 6
}</code></pre>

                <div class="success">
                    <p>âœ… <code>resolveRule()</code> checks fields like <code>"Quality Measure"</code> on the <strong>row object you pass to it</strong>.</p>
                    <p>âœ… <code>pickStyle()</code> can read targets from <code>rowData[targetField]</code> and supports <code>{ value }</code> objects.</p>
                </div>
            </section>

            <section id="modes-conditions">
                <h2>4. Allowed Modes and Conditions</h2>
                <p>From <code>utils/highlight.js</code>:</p>

                <h3>Modes</h3>
                <p><code>"self" | "target" | "range" | "discrete" | "gradient" | "normal"</code></p>

                <h3>Conditions (used by <code>self</code> and <code>target</code>)</h3>
                <p><code>"&lt;" | "&gt;" | "&lt;=" | "&gt;=" | "=" | "!" | "KNN"</code></p>

                <div class="note">
                    <strong>Note:</strong> <code>KNN</code> is a special condition only used under <strong>target mode</strong>.
                </div>
            </section>

            <section id="common-fields">
                <h2>5. Common Config Fields (All Modes)</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Field</th>
                            <th>Type</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>mode</code></td>
                            <td>string</td>
                            <td>Highlight mode</td>
                        </tr>
                        <tr>
                            <td><code>bg</code></td>
                            <td>boolean</td>
                            <td>Apply background color</td>
                        </tr>
                        <tr>
                            <td><code>text</code></td>
                            <td>boolean</td>
                            <td>Apply text color</td>
                        </tr>
                        <tr>
                            <td><code>overrideLinks</code></td>
                            <td>boolean (optional)</td>
                            <td>If true, link text also uses highlight color; otherwise links stay blue</td>
                        </tr>
                        <tr>
                            <td><code>nullBg</code></td>
                            <td>string (optional)</td>
                            <td>Background color when value is null/invalid</td>
                        </tr>
                        <tr>
                            <td><code>nullText</code></td>
                            <td>string (optional)</td>
                            <td>Text color when value is null/invalid</td>
                        </tr>
                        <tr>
                            <td><code>rules</code></td>
                            <td>array (optional)</td>
                            <td>Row-aware overrides applied before styling</td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <section id="value-parsing">
                <h2>6. Value Parsing and Null Behavior</h2>

                <h3>6.1 Numeric Parsing</h3>
                <p>For numeric modes, strings are parsed using <code>parseNumericValue()</code>:</p>
                <ul>
                    <li>Removes commas, currency symbols, <code>%</code>, etc.</li>
                    <li>Keeps a single leading <code>+/-</code></li>
                    <li>Allows one decimal point</li>
                </ul>

                <h4>Examples:</h4>
                <ul>
                    <li><code>"1,234"</code> â†’ <code>1234</code></li>
                    <li><code>"10.5%"</code> â†’ <code>10.5</code></li>
                    <li><code>"â‚¹ 200"</code> â†’ <code>200</code></li>
                </ul>
                <p>If parsing fails â†’ <code>NaN</code></p>

                <h3>6.2 Null / Empty / Invalid Values</h3>
                <p>If value is <code>null | undefined | "" | NaN</code>:</p>
                <ul>
                    <li>Background defaults to <code>"transparent"</code> (or <code>nullBg</code>)</li>
                    <li>Text defaults to <code>"#666"</code> (or <code>nullText</code>)</li>
                </ul>
                <p>These defaults are applied <strong>only if</strong>:</p>
                <ul>
                    <li><code>bg: true</code> â†’ background applied</li>
                    <li><code>text: true</code> â†’ text applied</li>
                </ul>
                <p>Otherwise fallback is used.</p>
            </section>

            <section id="colors">
                <h2>7. How Colors Are Applied (<code>bg</code> and <code>text</code> flags)</h2>
                <p>Your system supports two style formats:</p>

                <h3>A) Single Color String</h3>
                <p>Example: <code>"#F88484"</code></p>
                <ul>
                    <li><code>bg=true, text=true</code> â†’ background = that color, text auto-contrasted</li>
                    <li><code>bg=true, text=false</code> â†’ background only</li>
                    <li><code>bg=false, text=true</code> â†’ text only</li>
                </ul>

                <h3>B) <code>[bg, text]</code> Array</h3>
                <p>Example: <code>["#F88484", "#fff"]</code></p>
                <ul>
                    <li>If <code>bg=true</code>, background uses first value</li>
                    <li>If <code>text=true</code>, text uses second value (or auto-contrast if missing)</li>
                </ul>

                <div class="note">
                    Auto-contrast uses YIQ (<code>autoContrast()</code>).
                </div>
            </section>

            <section id="modes">
                <h2>8. Modes (With Examples)</h2>

                <h3 id="mode-self">8.1 <code>self</code> â€” Compare Cell vs Threshold</h3>
                <div class="badge required">Required</div>
                <ul>
                    <li><code>condition</code></li>
                    <li><code>threshold</code></li>
                    <li><code>good</code> and <code>bad</code> must be <code>[bg,text]</code> arrays</li>
                </ul>
                <pre><code>{
  "mode": "self",
  "condition": "&lt;",
  "threshold": 0,
  "good": ["#6AEB94", "#000"],
  "bad": ["#F88484", "#fff"],
  "bg": true,
  "text": true
}</code></pre>

                <h3 id="mode-target">8.2 <code>target</code> â€” Compare Cell vs Another Field</h3>
                <div class="badge required">Required (non-KNN)</div>
                <ul>
                    <li><code>targetField</code> (string OR array)</li>
                    <li><code>condition</code> (not KNN)</li>
                    <li><code>good</code> / <code>bad</code> arrays</li>
                </ul>
                <pre><code>{
  "mode": "target",
  "condition": "&lt;=",
  "targetField": "rate_calculation",
  "good": ["#6AEB94", "#000"],
  "bad": ["#F88484", "#fff"],
  "bg": true,
  "text": true
}</code></pre>

                <div class="note">
                    <strong>Important behavior:</strong> If <code>targetField</code> is an array, your normal compare logic still picks the <strong>first non-null target value</strong> and compares against it.
                </div>

                <h3 id="mode-knn">8.3 <code>target</code> + <code>condition: "KNN"</code> â€” Nearest Target Match</h3>
                <div class="badge required">Required</div>
                <ul>
                    <li><code>targetField</code>: string or array of strings</li>
                    <li><code>knnColors</code>: array of styles, same length as <code>targetField</code></li>
                </ul>
                <p>âœ… Does NOT require <code>good/bad</code>.</p>
                <pre><code>{
  "mode": "target",
  "condition": "KNN",
  "targetField": ["p10", "p50", "p90"],
  "knnColors": [
    ["#F88484", "#fff"],
    ["#F5F4AE", "#000"],
    ["#6AEB94", "#000"]
  ],
  "bg": true,
  "text": true
}</code></pre>

                <h4>How it works:</h4>
                <ol>
                    <li>Read all target values from row</li>
                    <li>Compute <code>abs(cellValue - targetValue)</code> for each</li>
                    <li>Choose the minimum distance
                        <ul>
                            <li>If tie, the <strong>last</strong> closest target wins</li>
                        </ul>
                    </li>
                    <li>Apply the corresponding <code>knnColors[index]</code></li>
                </ol>

                <h3 id="mode-range">8.4 <code>range</code> â€” Bucket Values into Ranges</h3>
                <div class="badge required">Required</div>
                <ul>
                    <li><code>ranges[]</code> must be non-empty</li>
                </ul>
                <pre><code>{
  "mode": "range",
  "ranges": [
    { "min": 0, "max": 10, "bg": "#F88484", "text": "#fff" },
    { "min": 10, "max": 20, "bg": "#F5F4AE", "text": "#000" },
    { "min": 20, "max": 100, "bg": "#6AEB94", "text": "#000" }
  ],
  "bg": true,
  "text": true
}</code></pre>

                <h4>Boundary behavior in code:</h4>
                <ul>
                    <li>Match if <code>v &gt;= min && v &lt; max</code></li>
                    <li>Or if <code>v === max</code> (fallback match)</li>
                </ul>

                <h3 id="mode-discrete">8.5 <code>discrete</code> â€” Match Exact Values</h3>
                <div class="badge required">Required</div>
                <ul>
                    <li><code>discrete</code> object mapping</li>
                </ul>
                <pre><code>{
  "mode": "discrete",
  "discrete": {
    "Yes": { "bg": "#6AEB94", "text": "#000" },
    "No":  { "bg": "#F88484", "text": "#fff" }
  },
  "bg": true,
  "text": true
}</code></pre>

                <h3 id="mode-gradient">8.6 <code>gradient</code> â€” Smooth Color Intensity</h3>
                <div class="badge required">Required</div>
                <ul>
                    <li><code>gradient.min</code>, <code>gradient.max</code> (max &gt; min)</li>
                </ul>
                <pre><code>{
  "mode": "gradient",
  "gradient": { 
    "min": 0, 
    "max": 100, 
    "palette": "green", 
    "invert": false 
  },
  "bg": true,
  "text": true
}</code></pre>

                <h4>Palettes available:</h4>
                <ul>
                    <li><code>green</code></li>
                    <li><code>red</code></li>
                    <li><code>blue</code></li>
                    <li><code>gray</code></li>
                </ul>

                <h3 id="mode-normal">8.7 <code>normal</code> â€” Constant/Static Color</h3>
                <p>Use when you want a cell to always have specific background/text color.</p>
                <div class="badge required">Required</div>
                <p>At least one of:</p>
                <ul>
                    <li><code>bgcolor</code></li>
                    <li><code>txtcolor</code></li>
                </ul>
                <pre><code>{
  "mode": "normal",
  "bgcolor": "#003366",
  "txtcolor": "#ffffff",
  "bg": true,
  "text": true
}</code></pre>
            </section>

            <section id="rules">
                <h2>9. Row-Aware Rules (Dynamic Overrides Per Row)</h2>
                <p>Rules let highlight behavior change depending on other values in the same row.</p>

                <h3>Rules Format</h3>
                <pre><code>"rules": [
  {
    "if": { 
      "field": "Quality Measure", 
      "operator": "in", 
      "values": ["A", "B"] 
    },
    "then": { "condition": "&gt;" }
  },
  {
    "else": { "condition": "&lt;" }
  }
]</code></pre>

                <h3>Supported Operators</h3>
                <ul>
                    <li><code>in</code>, <code>not in</code></li>
                    <li><code>=</code>, <code>!=</code></li>
                    <li><code>&gt;</code>, <code>&lt;</code>, <code>&gt;=</code>, <code>&lt;=</code> <em>(numeric via parseFloat)</em></li>
                </ul>

                <h3>How Rule Resolution Works</h3>
                <ul>
                    <li>First matching <code>if</code> wins</li>
                    <li>If none match and an <code>else</code> exists â†’ else applied</li>
                    <li>Effective config becomes <code>{ ...cfg, ...then/else }</code></li>
                </ul>

                <div class="success">
                    âœ… Rules can override any property: mode, condition, targetField, good/bad, knnColors, etc.
                </div>
            </section>

            <section id="validation">
                <h2>10. Validation Rules (What Must Exist)</h2>
                <p>Your <code>validateConfig()</code> enforces:</p>

                <h3><code>self</code></h3>
                <ul>
                    <li><code>threshold</code> required</li>
                    <li><code>good</code> and <code>bad</code> must be arrays</li>
                </ul>

                <h3><code>target</code></h3>
                <ul>
                    <li><code>targetField</code> required (string or array)</li>
                </ul>

                <h4>If <code>condition === "KNN"</code></h4>
                <ul>
                    <li><code>knnColors</code> required</li>
                    <li><code>knnColors.length</code> must match <code>targetField count</code></li>
                    <li><code>good/bad</code> NOT required</li>
                </ul>

                <h4>Else (normal target)</h4>
                <ul>
                    <li><code>good</code> and <code>bad</code> arrays required</li>
                </ul>

                <h3><code>range</code></h3>
                <ul>
                    <li><code>ranges[]</code> required</li>
                </ul>

                <h3><code>discrete</code></h3>
                <ul>
                    <li><code>discrete</code> required</li>
                </ul>

                <h3><code>gradient</code></h3>
                <ul>
                    <li><code>gradient.min/max</code> numeric and max &gt; min</li>
                </ul>

                <h3><code>normal</code></h3>
                <ul>
                    <li>Requires <code>bgcolor</code> or <code>txtcolor</code> (strings)</li>
                </ul>
            </section>

            <section id="links">
                <h2>11. Links + Highlight Behavior</h2>
                <p>If the cell has a backlink (<code>cellData.link.base_url</code>), it renders as <code>&lt;a&gt;</code>.</p>
                <ul>
                    <li>By default links remain <strong>blue</strong></li>
                    <li>If <code>overrideLinks: true</code>, link text uses highlight color instead</li>
                </ul>
                <p>Background highlight still applies either way.</p>
            </section>

            <section id="export">
                <h2>12. Export Compatibility</h2>

                <h3>Excel Export</h3>
                <p>Excel export re-runs highlighting using:</p>
                <ul>
                    <li>Raw row (<code>rawRows</code>)</li>
                    <li>Original cell value (<code>rawCell.value</code> when object)</li>
                    <li>Same <code>resolveRule()</code> + <code>pickStyle()</code> logic</li>
                </ul>
                <p>So the exported sheet retains highlight colors.</p>

                <h3>Image Export</h3>
                <p>Image export renders an <code>ExportTable</code> and screenshots it, so it captures visible highlights.</p>
            </section>

            <section id="standard-colors">
                <h2>13. Standard Colors (Your Reference)</h2>

                <h3>Normal</h3>
                <ul>
                    <li><span class="color-swatch" style="background: #6AEB94;"></span>Green: <code>#6AEB94</code></li>
                    <li><span class="color-swatch" style="background: #F88484;"></span>Red: <code>#F88484</code></li>
                </ul>

                <h3>Percentiles</h3>
                <ul>
                    <li><span class="color-swatch" style="background: #F88484;"></span>10th: <code>#F88484</code></li>
                    <li><span class="color-swatch" style="background: #FF954A;"></span>30th: <code>#FF954A</code></li>
                    <li><span class="color-swatch" style="background: #F5F4AE;"></span>50th: <code>#F5F4AE</code></li>
                    <li><span class="color-swatch" style="background: #64C7F6;"></span>70th: <code>#64C7F6</code></li>
                    <li><span class="color-swatch" style="background: #6AEB94;"></span>90th: <code>#6AEB94</code></li>
                </ul>
            </section>

            <section id="troubleshooting">
                <h2>14. Troubleshooting Checklist</h2>
                <p>If highlights don't show:</p>

                <div class="warning">
                    <ol>
                        <li>Config failed validation â†’ <code>safeValidateConfig</code> returned false â†’ highlight removed</li>
                        <li>Value is null/empty/NaN â†’ fallback style used</li>
                        <li>Target field missing or non-numeric â†’ target mode can't compare</li>
                        <li>Rules not matching â†’ check <code>field</code> names exist in row</li>
                        <li>Link stays blue â†’ set <code>overrideLinks: true</code></li>
                        <li>For KNN:
                            <ul>
                                <li>Ensure <code>targetField</code> count matches <code>knnColors.length</code></li>
                                <li>Ensure target fields exist and are numeric</li>
                            </ul>
                        </li>
                    </ol>
